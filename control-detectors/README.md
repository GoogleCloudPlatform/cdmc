# CDMC REPORT ENGINE

This folder contains the CDMC Report Engine, the python application which based on configuration files, configuration tables and BigQuery jobs metadata inspects that BigQuery sensitive data assets follow the CDMC controls.

The repository contains 12 dedicated controls implementations classes which refers to the 14 CDMC controls, being controls 1 and 5 implicitly implemented and not having dedicated classes.

GCP CDMC Report Engine is a Python flask application, with execution based on rest requests.


## DEPLOYMENT

### REQUIREMENTS

- Python3 environment;
- Metadata generated by [TAG Engine](https://github.com/GoogleCloudPlatform/datacatalog-tag-engine);
- Apply the terraform scripts in this folders, specifying the related variables define in Terraform variables template (terraform/terraform.tfvars.template). The Terraform scripts create:
- - A service account with the related roles to access metadata in Organization level, and access to Pub/Sub and BigQuery in project level;
- - Pub/Sub topics for events and data_assets, with related Pub/Sub schemas and BQ subscribers;
- - BigQuery dataset and tables for events and data assets logs;

After the execution of the requirements, Report Engine can be deployed in Cloud Run (recommended) or Compute Engine.


### Cloud Run (Recommended)

Steps:
- In resources/config.ini file, replace all <PROJECT_ID> references to your deployment project ID (same as set in terraform.tvars -> project variable);
- - Sample replacement: 

```
sed -i 's/<PROJECT_ID>/my-data-governance-id/' resources/config.ini 
```

- Generate a cloud run deployment from the Dockerfile in this repo.


### Compute Engine

Steps:

- In resources/config.ini file, replace all <PROJECT_ID> references to your deployment project ID (same as set in terraform.tvars -> project variable);
- - Sample replacement: 

```
sed -i 's/<PROJECT_ID>/my-data-governance-id/' resources/config.ini 
```
- Install all Python requirements from requirements.txt file;
- Execute the python3 main.py file


## EXECUTION

CDMC Report Engine is a Flask web application. The following request parameters must be considered for the POST method in /generate:

- (Mandatory) orgId=<INTEGER> the GCP Organization ID of the inspection;
- (Mandatory) projectId=<STRING> the GCP Project ID to be inspected;
- (Mandatory) projectNumber= <INTEGER> the inspected GCP Project number
- (Mandatory) topicProjectId=<STRING> the GCP Project ID that has the Pub/Sub topic that receive the alerts;
- (Mandatory) topic=<STRING> the Pub/Sub topic name
- (Optional) controls= <String> the list of all CDMC controls to be inspected, the format of list are two digit per control. Ex.: 020312 inspects the controls 02, 03 and 12. The default value is “all”.
- (Optional) assetsScope=<BOOLEAN> informs if the log of inspected assets must be sent to a Pub/Sub topic configured in config.ini ASSETS_SCOPE section. Default value is TRUE

Sample request format:
```
curl -X POST 'https://<endpoint>/generate?orgId=<INTEGER>&projectId=<STRING>&topicProjectId=<STRING>&topic=<STRING>&projectNumber=<INTEGER>&controls=020608'
```


## CONFIGURATION CHANGES

It is recommended that Dataplex Catalog templates, Pub/Sub topics and BigQuery configuration tables keep the original values, in case these values must be adjusted, the requirements/config.ini must be considered.

  
## Deployments from Secured Data Warehouse project or VPC Service Controls

In case the deployment occurs in a deployment of [Secure Data Warehouse](https://cloud.google.com/architecture/confidential-data-warehouse-blueprint), which uses VPC- Service Controls, or in a self deployed VPC-Service Control environment, consider the following aspects to be considered in the report-engine deployment:

- Evaluate and disable potential [Organization Policies](https://cloud.google.com/resource-manager/docs/organization-policy/restricting-service-accounts) that blocks the creation of Service Accounts in the deployment project;
- Create an egress rule enabling the "sa-report-engine@" service account, created by Terraform, to access data assets from the projects to be scanned;
- Create an Access Level, or update potential existing one, enabling the "sa-report-engine@" service account to access target deployment project/ data-governance;
- Create an Access Level, or update potential existing one, enabling the "sa-report-engine@" service account to access the data confidential project.

In case of Cloud Run deployment, potential Access Level modifications can be necessary, allowing deployments components, such as Cloud Build default Service Account or Pub/Sub default Service Account to BigQuery. This configurations change might be analyzed according to VPC-SC topology and definitions.


  
